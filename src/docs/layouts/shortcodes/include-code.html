{{- $pathWithAnchorTag := (.Get 0) -}}
{{- if $pathWithAnchorTag -}}
  {{- $language := (.Get 1) -}}
  {{- if $language -}}
    {{- $path := "" -}}
    {{- $tag := "" -}}
    {{- if in $pathWithAnchorTag "#" -}}
      {{- $split := split $pathWithAnchorTag "#" -}}
      {{- $path = index $split 0 -}}
      {{- $tag = index $split 1 -}}
    {{- else -}}
      {{- $path = $pathWithAnchorTag -}}
    {{- end -}}
    {{- $page := .Page.Resources.GetMatch (printf "**%s" $path) -}}
    {{- if $page -}}
      {{- $content := $page.Content -}}
      {{- if $tag -}}
        {{- if in $tag "," -}}
          {{- $content = "" -}}
          {{- range (split $tag ",") -}}
            {{- $anchor := printf "//#%s" . -}}
            {{- if in ($page.Content) $anchor -}}
              {{- $extract := index (split ($page.Content) $anchor) 1 -}}
              {{- $content = printf "%s\n\n%s" $content (trim $extract "\r\n") -}}
            {{- else -}}
              {{- errorf "%s: missing anchor tag %s inside file %s in page %q" $.Position $anchor $path -}}
            {{- end -}}
          {{- end -}}
        {{- else -}}
          {{- $anchor := printf "//#%s" $tag -}}
          {{- if in ($page.Content) $anchor -}}
            {{- $extract := index (split ($page.Content) $anchor) 1 -}}
            {{- $content = trim $extract "\r\n" -}}
          {{- else -}}
            {{- errorf "%s: missing anchor tag %s inside file %s" .Position $anchor $path -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
      {{- highlight $content $language "" -}}
    {{- else -}}
      {{- errorf "%s: file %s not found" .Position $path -}}
    {{- end -}}
  {{- else -}}
    {{- errorf "%s: missing highlight language" .Position -}}
  {{- end -}}
{{- else -}}
  {{- errorf "%s: missing resource name" .Position -}}
{{- end -}}
